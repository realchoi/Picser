# SVG 格式支持实施计划

## 阶段 1: 基础格式定义 ✅
**目标**: 在系统中注册 SVG 格式，使其被识别为支持的图片类型
**成功标准**:
- [x] ImageDiscovery 识别 .svg 扩展名
- [x] FormatUtils 正确显示 SVG 格式名称
- [x] MetadataCache 支持 SVG 格式标记
**测试**: 打开包含 SVG 的文件夹，检查文件列表
**状态**: ✅ Complete

## 阶段 2: SVG 加载逻辑 ✅
**目标**: 实现 SVG 文件的加载和显示
**成功标准**:
- [x] SVG 文件能够在主视图中正确显示
- [x] 处理无尺寸 SVG（设置默认尺寸）
- [x] 加载失败有合理的错误处理
**测试**: 打开简单和复杂 SVG 文件，验证显示正确
**状态**: ✅ Complete

## 阶段 3: 缩略图生成 ✅
**目标**: SVG 文件在缩略图列表中正确显示
**成功标准**:
- [x] SVG 缩略图正常生成
- [x] 缩略图尺寸合理
- [x] 性能可接受（不明显卡顿）
**测试**: 打开包含多个 SVG 的文件夹，检查缩略图列表
**状态**: ✅ Complete

## 阶段 4: 编辑功能适配 ✅
**目标**: 确保编辑功能与 SVG 兼容
**成功标准**:
- [x] 缩放功能正常工作
- [x] 旋转/翻转功能正常工作
- [x] 保存功能有合理的提示或限制
**测试**: 对 SVG 执行缩放、旋转、翻转、保存操作
**状态**: ✅ Complete

## 阶段 5: 测试与验证 ✅
**目标**: 全面测试各种边界情况
**成功标准**:
- [x] 简单 SVG 图标正常显示
- [x] 复杂 SVG（渐变、滤镜）正常显示
- [x] 无尺寸 SVG 有默认显示
- [x] 所有现有功能未受影响
**测试**: 使用多种 SVG 测试用例验证
**状态**: ✅ Complete

## 阶段 6: 问题修复与优化 ✅
**目标**: 修复用户反馈的问题
**成功标准**:
- [x] SVG 裁剪时正确显示错误提示
- [x] 错误提示信息不硬编码格式名称
- [x] SVG 信息查看功能正常工作
- [x] SVG namespace 警告有文档说明
**测试**: 裁剪 SVG、查看信息、检查控制台
**状态**: ✅ Complete

---

## 实施总结

### ✅ 已完成的修改

#### 1. 格式定义（3 个文件）
- **ImageDiscovery.swift:15** - 添加 "svg" 到支持的扩展名集合
- **FormatUtils.swift:61** - 添加 SVG 格式显示名称
- **MetadataCache.swift:80-82** - SVG 映射到 .other 格式（保持数据库兼容性）

#### 2. 图片加载逻辑（ImageLoader.swift）
- **新增方法 loadSVGImage** (line 342-361) - SVG 专用加载，处理无尺寸情况
- **新增方法 resizeImage** (line 363-389) - NSImage 缩放辅助方法
- **修改 loadImageByFormat** (line 134-156) - 添加 SVG 差异化加载
- **修改 loadOptimizedImage** (line 160-179) - SVG 直接返回完整图
- **修改 createThumbnailData** (line 241-292) - SVG 缩略图特殊处理

#### 3. 编辑功能兼容（ImageCropper.swift）
- **新增错误类型 unsupportedFormat** (line 18) - 用于 SVG 不支持裁剪/保存
- **修改 crop 方法** (line 27-28) - 在 crop 阶段拦截 SVG 格式
- **修改 save 方法** (line 54-56) - 在 save 阶段拦截 SVG 格式

#### 4. 错误处理优化（ContentView+Crop.swift）
- **新增方法 startCropping** (line 13-39) - 裁剪前的格式检查和模式切换
- **增强错误处理** (line 60-70) - 保存时的错误处理（防御性编程）
- **动态格式名称** (line 62-65) - 从 URL 提取格式名称，不硬编码

#### 5. 工具栏按钮优化（ContentView+Toolbar.swift）
- **修改裁剪按钮** (line 100-101) - 调用 startCropping() 而非直接切换状态

#### 6. 信息显示支持（ExifExtractor.swift）
- **新增 SVG 分支** (line 38-40) - 检测 SVG 格式特殊处理
- **新增方法 extractBasicInfoForSVG** (line 81-112) - 为 SVG 提供基础信息

#### 7. 本地化字符串（Localizable.xcstrings）
- **crop_save_error_title** - "保存失败" / "Save Failed"
- **crop_save_error_message** - 通用错误消息
- **crop_save_unsupported_format** - 使用 `%@` 占位符，支持动态格式名称

---

### 📝 技术要点

#### 使用 NSImage 原生支持
- macOS 10.15+ 原生支持 SVG 加载
- 不支持 SVG 动画（SMIL/CSS）
- 简单高效，与现有架构兼容

#### 与位图格式的差异
- SVG 是矢量格式，无固定分辨率
- 无尺寸 SVG 设置默认值 512x512
- 缩略图需要先加载再光栅化
- 直接返回完整图（无需下采样）
- **不支持裁剪**（crop 阶段就拦截）

#### 错误处理策略
- **在最早阶段检测**：crop 方法开头就检查 SVG
- **精确的错误类型**：unsupportedFormat 用于不支持的格式
- **动态错误消息**：根据实际格式生成提示信息
- **双重拦截**：crop 和 save 都检查，防止遗漏

#### SVG namespace 警告
- **原因**：SVG 文件使用实体引用（`&ns_svg;`）而非标准 URI
- **来源**：macOS 底层 libxml2 解析器
- **影响**：仅控制台警告，不影响功能
- **处理**：在代码注释中说明，可安全忽略

#### 已知限制
- ❌ 不支持 SVG 动画（SMIL/CSS）
- ❌ 不支持裁剪 SVG（crop 阶段拦截）
- ❌ 不支持导出为 SVG 格式（save 阶段拦截）
- ✅ 可查看基础信息（尺寸、大小、修改日期等）
- ✅ 缩放、旋转、翻转功能正常工作（光栅化后）
- ⚠️  不规范的 SVG 可能产生 namespace 警告（无害）

---

### 🧪 测试建议

准备以下测试用例：
1. **简单 SVG** - 基本形状（圆形、矩形）
2. **复杂 SVG** - 渐变、滤镜、路径
3. **大尺寸 SVG** - 测试性能
4. **无尺寸 SVG** - 没有 width/height 属性
5. **动画 SVG** - SMIL/CSS 动画（预期不支持动画）
6. **特殊字符 SVG** - 中文文本、特殊字体
7. **不规范 SVG** - 使用实体引用的 namespace（测试警告）

测试场景：
- ✅ 打开单个 SVG 文件
- ✅ 打开包含 SVG 的文件夹
- ✅ 缩略图列表显示
- ✅ 缩放功能
- ✅ 旋转/翻转功能
- ✅ **裁剪按钮点击（应立即提示，不进入裁剪模式）** ← 关键改进
- ✅ 信息查看功能（显示基础信息）
- ✅ 保存/导出功能（防御性错误处理）

---

### 📊 代码质量

- ✅ 所有修改编译通过
- ✅ 代码注释清晰完整
- ✅ 逻辑精简，无冗余
- ✅ 错误处理合理且精确
- ✅ 保持向后兼容性
- ✅ 本地化支持完整

---

### 🐛 已修复的问题

#### 问题 1：裁剪保存无错误提示
- **现象**：裁剪 SVG 后保存为 .svg 格式时，无任何提示，且保存失败
- **原因**：`ImageCropper.crop()` 使用 `CGImageSource` 处理 SVG 失败，抛出通用错误
- **修复**：在 crop 方法开头检查 SVG，提前抛出 unsupportedFormat 错误
- **结果**：用户看到明确的错误提示："SVG 格式不支持裁剪操作"

#### 问题 2：错误提示时机太晚（关键 UX 问题）
- **现象**：用户点击裁剪按钮 → 调整裁剪框 → 选择保存位置 → **才显示错误**
- **原因**：格式检查在保存时才执行，用户浪费大量时间和精力
- **修复**：在裁剪按钮点击时立即检查格式（Fail Fast 原则）
- **实现**：新增 `startCropping()` 方法，在工具栏按钮中调用
- **结果**：用户点击裁剪按钮时立即看到提示，不会进入裁剪模式

#### 问题 3：错误提示逻辑矛盾
- **现象**：提示"请导出为 PNG 或 JPEG"，但无论保存为什么格式都会失败
- **原因**：问题不在保存格式，而在裁剪操作本身不支持矢量格式
- **修复**：将错误提示从"不支持编辑后保存"改为"不支持裁剪操作"
- **结果**：提示信息更准确，不再误导用户

#### 问题 3：错误提示硬编码原因
- **现象**：提示信息包含"是矢量格式"，假设了不支持的原因
- **原因**：`unsupportedFormat` 是通用错误，未来可能用于非矢量的不支持格式
- **修复**：去掉原因说明，只陈述事实："格式不支持裁剪操作"
- **结果**：提示信息完全通用，适用于任何不支持裁剪的格式

#### 问题 4：错误提示硬编码格式名称
- **现象**：早期版本提示信息固定为"SVG"
- **原因**：本地化字符串硬编码了格式名称
- **修复**：使用 `%@` 占位符，从 URL 动态提取格式名称
- **结果**：提示信息通用化，适用于任何不支持的格式

#### 问题 5：SVG 信息查看失败
- **现象**：点击查看信息按钮时提示 EXIF 加载错误
- **原因**：`CGImageSource` 无法处理 SVG 矢量格式
- **修复**：在 ExifExtractor 中为 SVG 提供专门的基础信息提取逻辑
- **结果**：SVG 可以正常查看基础信息（文件名、大小、尺寸等）

#### 问题 6：控制台 namespace 警告
- **现象**：打开 SVG 时控制台输出大量 "namespace warning: xmlns: URI is not absolute"
- **原因**：SVG 文件使用实体引用（`&ns_svg;`）而非标准 namespace URI
- **影响**：仅警告信息，不影响功能
- **处理**：在代码注释中说明这是已知的无害警告，可安全忽略
